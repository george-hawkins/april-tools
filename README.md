AprilTools
==========

See Default Cube's video ["Tracking with April Tools In-Depth"](https://youtu.be/g4s4fFmh8DQ).

---

The first issue was the tag - I had the issue described [here](https://github.com/AprilRobotics/apriltag-imgs/issues/4#issuecomment-850044277) that Preview on Mac and Chrome on Linux smoothed the tags.

I used one of the tags generated by @rgov instead:

* For [A4](https://github.com/rgov/apriltag-pdfs/blob/main/tag36h11/a4/200mm/tag36h11_200mm_id000.pdf).
* For [US Letter](https://github.com/rgov/apriltag-pdfs/blob/main/tag36h11/us_letter/200mm/tag36h11_200mm_id000.pdf).

---

For Docker set up, see [here](https://github.com/george-hawkins/docker-cplusplus-coroutines#setup).

---

There's almost nothing to AprilTools (see [`build-apriltools`](build-apriltools)) and the real work is being done by AprilTag (see [`build-apriltag`](build-apriltag)) and OpenCV.

---

To build the Docker image:

    $ docker-compose build

Then to run AprilTools:

    $ docker-compose run hirsute-apriltools apriltools --help
    Usage: apriltools [options] <input files>
      -h | --help                   [ true ]       Show this help   
      -p | --path                   [  ]           Path to the source image sequence   
      -f | --focal-length-mm        [ -1 ]         Focal length in mm   
      -F | --focal-length-pixels    [ -1 ]         Focal length in pixels   
      -w | --sensor-width           [ -1 ]         Camera sensor width in mm   
      -s | --tag-size               [ -1 ]         Tag size (black border, side of the square) in mm   
      -e | --estimate-focal-length  [ false ]      Do not track the marker; instead, estimate the camera focal length in pixels from the provided footage.   
      -q | --quick                  [ false ]      Speed up the process at the expense of reduced accuracy. 

---

Convert footage to frames:

    $ ffmpeg -i my-movie.mov frames/frame-%04d.png

And work out which ones you want to use.

---

I kept the range 1478 to 1596. It turns out later that either AprilTools or Blender gets confused by this (it thinks there are 1596 frames with the first 1477 missing).

So renumber things:

    $ mv frames frames-orig
    $ mkdir frames
    $ cd frames-orig
    $ count=1
    $ for frame in frame-*.png
    do
        mv $frame ../frames/frame-$(printf "%04d" $count).png
        let count++
    done

---

Estimate the focal length:

    $ docker-compose run hirsute-apriltools apriltools --path frames --estimate-focal-length

It didn't seem to do a very good job on my footage, it just output:

    Focal length estimation complete. Best guess: -1.00 px.

Which was nothing like the real values, so I used the value I knew were correct.

---

Measure the size of your tag, mine was 144mm on each side.

---

Get it to produce the camera track:

    $ docker-compose run hirsute-apriltools apriltools --focal-length-mm=18 --sensor-width=23.1 --tag-size 144 --path frames
    searching for files...
    Found 119 valid files in the specified directory.
    Processed 1/119 files, out of which 0 blurry (?) and 0 were unusable (no tag found).
    ...
    Processed 119/119 files, out of which 0 blurry (?) and 0 were unusable (no tag found).

    Focal length: 18.00 mm (1496.10 px); sensor width: 23.10 mm
    Camera track saved to: frames/track.txt
    Open Blender and go to file-> import -> Apriltools tracking data (install the plugin if you haven't already) to import the tracking data.

It writes it to `frames/track.txt`.

---

If you look at the `track.txt` file, you'll see:

```
$ head frames/track.txt 
frames/frame-1478.png
18.0000, 23.1000, 144.0000, 0, 0,0,0
1478, 1.6287,0.0313,-0.1006,1.1443,-0.4892,3.2717
```

It turns out that the `apriltags_import.py` importer can only work with absolute paths.

And as the path within the Docker container would be different to the local path, this is unfortunately something you have to resolve by hand.

Just edit the file and add in the full path, so you end up with:

```
$ head frames/track.txt 
/home/joebloggs/my-april-tools-project/frames/frame-1478.png
18.0000, 23.1000, 144.0000, 0, 0,0,0
1478, 1.6287,0.0313,-0.1006,1.1443,-0.4892,3.2717
```

---

Open Blender for _General_.

Install the add-on:

    $ curl -O https://raw.githubusercontent.com/thegoodhen/AprilTools/master/bin/apriltags_import.py

In Blender, go to _Edit / Preference / Add-ons_, click _Install_, find and select the `apriltags_import.py` file and click _Install Add-on_.

After an oddly long pause, it should show up in the list of add-ons. So tick it to enable it.

---

Delete the default cube. Go to _File / Import / Apriltools tracking data_ and import your `track.txt` file.

Things look a little unusual at first, the small plane, you see at the origin actually correspond to your tag.

If you then go to the camera view and press play, you'll see the plane covering the marker as the frames play.

Note: initially, nothing worked because `track.txt` didn't contain an absolute path (see above) and because the frames weren't numbered from 1. Once this was resolved, I didn't have to do anything, the scene length was set correctly (i.e. it wasn't just left at the default 250).

The only thing I had to do was go to _Render_ properties, expand _Color Management_ and set _View Transform_ to _Standard_.

---

The tag looks a little tiny in Blender - but it's tiny in real life - it's got the correct dimensions, i.e. 144x144mm in my case.

---

To make it easier to move and scale things such that the camera and tag maintain the correct relationship.

Make sure nothing is select, then `shift-A` and select _Empty / Plain Axes_. Unselect it, then shift-click the plane, the camera and lastly the empty, press `ctrl-P` (for parenting) and select _Object_.

Now, you can move the tag to a position that better matches where it was in the real world, e.g. rather than being flat on the ground my tag was on a wall about 2m up. So in my case, I went:

* Top-view - `Numpad-7` - selected the empty and then `r90` (and return).
* Side-view - `Numpad-3` - and `r-90` and then `gz2`.

Now, when looking from the front-view, the camera is closest to the viewer and facing the tag that's now facing the viewer and is 2m off the ground.


